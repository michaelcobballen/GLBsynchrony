---
title: "Spatial synchrony of grassland birds"
author: "Mike Allen"
date: "July 13, 2020"
output: html_document
---
# Readme
This code processes route-level Breeding Bird Survey count data summarized into 2x2 degree grid-cells to analyze spatial synchrony for 19 species of grassland birds. See Links at bottom for data sources, references, etc.

# Section 1. Load libraries, functions, data

## 1.1 Load packages, functions, & species data
We started with 30 grassland-specialist species. The 11 species excluded here did not have enough data for synchrony analysis after processing (see paper). Edit the csv data file and this code if you want to use a different list of species. And edit the code below if you want to create customize time periods (currently it is set for 1968-1993 and 1994-2019).
```{r, warning = F}
library(tidyverse)
library(bbsBayes)
library(rgdal)
library(maps)
library(ggthemes)
library(mapproj)
library(forcats)
source("scripts/functions/gridcollapse.func.R") # function to prepare raw BBS data within 2 x 2 degree grid cells formatted for the Bayesian (JAGS) model (modified bbsBayes code)
source("scripts/functions/run.gamyet.func.R") # function to run the hierarchical JAGS model to generate BBS indices for 2 x 2 degree grid cells (modified from bbsBayes code)
source("scripts/functions/mapsync.func.R") # function to perform synchrony calculations (either iteratively on bootstrapped datasets from the posterior or on posterior medians) 
#load("data/sync.summaries.Rdata") # load synchrony summaries to skip section 4
`%notin%` <- Negate(`%in%`) # function for "does not contain"
is.odd <- function(x) x %% 2 != 0 # functions for identifying odd numbers

species = read.csv("data/species_names.csv", stringsAsFactors = F) %>%
  bind_rows(read.csv("data/species_names.csv", stringsAsFactors = F)) %>%
  mutate(startyr = c(rep(1968,30),rep(1994,30)),
         endyr = c(rep(1993,30), rep(2019,30))) %>%
  filter(spcode %notin% c("lepc", "stgr", "mopl", "bano", "bosp", "wtha", "grpc", "seow", "feha", "hesp", "mclo"))
# excluded 5 species which didn't have enough data to run Jags model
# and wtha, grpc, seow, feha (no final grid cells in per 1)
# and hesp, mclo (0 & 4 final qualifying cells for difference calculations)
```
# Section 2. Setup and run JAGS model to generate BBS indices
## 2.1. Access BBS data via bbsBayes package
You only need to run this code once. You'll need to accept the terms of use.
```{r}
#bbs_data <- fetch_bbs_data() # get BBS data (only need to run this once ever)
```
## 2.2. Format BBS data & export csv files that will be used in model
This code generates a csv file for each species and time period (saved to the data/jags folder) that will be used to run hierarchical models to generate BBS indices for 2x2 degree grid cells. The code, functions, and model (GAMYE-t) are from the bbsBayes package (Edwards & Smith 2020). It was necessary to generate a large number of CSV's (rather than running it all within bbsBayes) so that the hierarchical models could be run in the JagsUI package on a supercomputer cluster (which could not run bbsBayes). This code customizes the bbsBayes code to stratify by 2x2 degree instead of 1x1 grid cells. This step takes several minutes.
```{r}
#####################################
####  a loop to create all species JAGS data files (as csv files)
#####################################
for (i in 1:nrow(species)) {
  gridcollapse(
    spcode = species$spcode[i],
    species = species$species[i],
    startyr = species$startyr[i],
    endyr = species$endyr[i],
    save.loc = "data/jags/" # where to write .csv files
  )
}
#####################################
#### OR create JAGS data for one species at a time (as csv files)
#####################################
#gridcollapse(
#  spcode = "bais",
#  species = "Baird's Sparrow",
#  startyr = 1994,
#  endyr = 2019,
#  save.loc = "data/jags/" # where to write .csv file
#)
```

## 2.3. Run Jags models to generate BBS indices
This runs the Bayesian hierarchical model to generate BBS indices for each species/grid/year. The model is the General Additive Model with Year (heavy-tailed option) from the bbsBayes package (Edwards & Smith 2020). These cam take ~1-10+ hours for each species/period (running on 3 cores in parallel) depending on how widespread the species is (e.g., BAIS took ~45 min, while SAVS took 10+ hours). Thus, we ran most on the Rutgers Amarel supercomputer cluster. You can customize the MCMC parameters using the chains, iter, burn, and thin arguments (currently they are set at the bbsBayes defaults).
```{r}
#####################################
#### to run hierarchical model for a single species and period
#####################################
run.gamyet(
  spcode = "bais",
  species = "Baird's Sparrow",
  startyr = 1994,
  endyr = 2019, 
  chains = 3, # number of chains
  burn = 20000, # number of burn-in iterations per chain
  iter = 30000, # total number of iterations per chain including the burn-in
  thin = 10, # keep every X iterations
  par = T, # run chains in parallel?
  gamyet.loc = "scripts/jags/gamyet.bug", # location of the JAGS code file
  data.loc = "data/jags/", # location of the JAGS data prepared in the previous step
  save.posteriors = "data/index_posteriors/", # location to save the posterior samples to
  save.rawcounts = "data/raw_counts/" # location to save the "raw count" file to
  )
# csv files are exported to the locations specified in "save.posteriors" and "save.rawcounts"

#####################################
#### OR use this code to run for all species and periods (not recommended as this would take a _very_ long time)
#####################################
#for(i in 1:nrow(species)){
#  run.gamyet(spcode = species$spcode[i],
#             species = species$species[i],
#             startyr = species$startyr[i],
#             endyr = species$endyr[i]
#             )
#}
```
# Section 3. Computing mean spatial synchrony by species and grid cell
## 3.1 Compute mean spatial synchrony (r)
Setting other.metrics to "F" computes synchrony metrics (mean r) using linear detrending; setting this to "T" also computes mean abundance, variance, and trends for cells. The former is quicker. Setting uncertainty to "T" computes the metrics numerous times (set using "n.iter") on data sets created by resampling from the posterior distribution; setting it to "F" only computes them once using the median values of the posteriors. The latter is quicker. For reference, this function took ~15 minutes for a widespread species (Savannah Sparrow) on a laptop with all.methods = F and uncertainty = T. The resulting csv files of mean correlations saves to the location indicated by "save.to".
```{r}
#####################################
#### code to compute mean spatial synchrony for a single species and time period
#####################################
mapsync(
  spcode = "hola",
  startyr = 1968,
  endyr = 1993,
  n.iter = 3000, # number of data sets to create by resampling from the posterior distributions
  n.post = 3000, # number of posterior samples that exist for each population estimate
  uncertainty = T, # if TRUE, creates n.iter data sets resampled from the posteriors; if FALSE, creates one data set from posterior medians
  maxzeros = 5, # sets the maximum number of zeros (in raw count data) to allow within each grid cell time series
  other.metrics = T, # logical indicating whether to calculate mean abundance, mean variance, mean trend in addition to mean synchrony
  posterior.data.loc = "data/index_posteriors/",
  jags.data.loc = "data/jags/",
  save.to = "data/mapsync_iterations/"
)
#####################################
#### OR compute mean synchrony for all species and time periods
#### note: can take a few minutes to a few hours per species and time period
#####################################
for(i in 1:nrow(species)){ 
  mapsync(
    spcode = species$spcode[i],
    startyr = species$startyr[i],
    endyr = species$endyr[i],
    n.iter = 3000,
    n.post = 3000,
    uncertainty = T,
    maxzeros = 5,
    other.metrics = T,
    posterior.data.loc = "data/index_posteriors/",
    jags.data.loc = "data/jags/",
    save.to = "data/mapsync_iterations/"
  )
}
```
# Section 4. Summarize spatial synchrony data for mapping and analysis
## 4.1. Read in files with mean synchrony data (mean synchrony calculated from many resampled data sets from the BBS index posterior distributions)
```{r}
# set folder location of "mapsync" files
mapsync.loc = "data/mapsync_iterations/"
```
# 4.2. Load mean synchrony (r) data set iterations for each species
Synchrony iterations were generated based on 3000 data sets from random draws of the BBS index posterior distributions (3000 for each species/grid cell/year). Computed mean r for each species/cell for each data set, resulting in a distribution of synchrony and synchrony difference estimates for each species/cell/year.
```{r}
# make a list of files containing the mean synchrony data sets
mapsync.files = sprintf(
  paste0(mapsync.loc,"%s.mapsync.iterations.csv"),
  paste0(
    species$spcode,
    ".",
    substr(species$startyr, 3, 4),
    ".",
    substr(species$endyr, 3, 4)
  )
)

# read in all mapsync data into list form
mapsync.iterations = lapply(mapsync.files, function(x)
  read.csv(x))
names(mapsync.iterations) <-   paste0(species$spcode,
                                      ".",
                                      substr(species$startyr, 3, 4),
                                      ".",
                                      substr(species$endyr, 3, 4))
rm(mapsync.files, mapsync.loc)
```
## 4.2. Subset only grid cells with adequate data from both time periods
```{r}
# get a list of the grid cells in common between periods for each species (for filtering)
gridcom = function(x) {
  Reduce(intersect, list(
    unique(mapsync.iterations[[x]]$grid),
    unique(mapsync.iterations[[x + length(unique(species$spcode))]]$grid)
  ))
}

numsp = length(unique(species$spcode))
grid.common = lapply(1:numsp, gridcom)
names(grid.common) = unique(species$spcode)

grid.common2 = c(grid.common, grid.common)

# subset only the grid cells in common between the two time periods
mapsync.com = list()
for (i in 1:nrow(species)) {
  mapsync.com[[i]] = filter(mapsync.iterations[[i]], grid %in% grid.common2[[i]])
}
names(mapsync.com) <- species$spcode

rm(grid.common, grid.common2, mapsync.iterations)
```
## 4.3. Create mean synchrony data sets for period 1, period 2, and the difference 
```{r}
# separate out period one, period two, and subtract the two to get change in synchrony
mapsync.com1 = mapsync.com[1:numsp]
mapsync.com2 = mapsync.com[(numsp+1):nrow(species)]
mapsync.dif1 = Map(function(listper2, listper1)
  listper2[, 3:6] - listper1[, 3:6],
  mapsync.com2,
  mapsync.com1)

# add in iteration and grid variables back to synchrony change
mapsync.dif = Map(function(mainlist, listnames)
  cbind(listnames[, 1:2], mainlist[, 1:4]),
  mapsync.dif1,
  mapsync.com1)

# add in species names
mapsync.dif.names = list()
for (i in 1:numsp) {
  mapsync.dif.names[[i]] = cbind.data.frame(species = species$spcode[i], mapsync.dif[[i]])
}
```
## 4.4. Average grid cells across species
```{r}
# create giant data frame with all iterations of dif, per1, and per2 for all spp
syncdif.all = cbind(
  do.call("rbind", mapsync.dif.names)[, c(1:7)],
  # difference
  do.call("rbind", mapsync.com1)[, c(3:6)],
  # period 1
  do.call("rbind", mapsync.com2)[, c(3:6)] # period 2
)
colnames(syncdif.all) = c(
  "spcode",
  "iteration",
  "grid",
  "sync.dif",
  "mean.dif",
  "var.dif",
  "trend.dif",
  "sync.one",
  "mean.one",
  "var.one",
  "trend.one",
  "sync.two",
  "mean.two",
  "var.two",
  "trend.two")

rm(mapsync.com, mapsync.com1, mapsync.com2, mapsync.dif1, mapsync.dif, mapsync.dif.names)
```

```{r}
# average by grid cell across species for each iteration
syncdif = syncdif.all %>%
  group_by(iteration, grid) %>%
  summarise(
    sync.dif = mean(sync.dif),
    mean.dif = mean(mean.dif),
    var.dif = mean(var.dif),
    trend.dif = mean(trend.dif),
    sync.one = mean(sync.one),
    mean.one = mean(mean.one),
    var.one = mean(var.one),
    trend.one = mean(trend.one),
    sync.two = mean(sync.two),
    mean.two = mean(mean.two),
    var.two = mean(var.two),
    trend.two = mean(trend.two),
    spp.per.grid = length(spcode)
  ) %>%
  ungroup() %>%
  filter(spp.per.grid >= 3) %>%
  dplyr::select(-spp.per.grid)
```

```{r}
# summarize synchrony change iterations by quantiles (all species)
syncdif.split = split(syncdif, f = syncdif$grid)

syncdif.sum.list = lapply(syncdif.split, function(x)
  apply(x[, 3:14], 2L, FUN = quantile, probs = c(0.05, 0.5, 0.95)))

syncdif.sum = data.frame(do.call("rbind", syncdif.sum.list)) %>%
  mutate(quant = rep(c("p5", "med", "p95"), length(syncdif.sum.list)),
         grid = c(mapply(
           unique(syncdif$grid),
           FUN = function(x)
             rep(x, 3)
         ))) %>%
  tidyr::pivot_wider(
    names_from = quant,
    values_from = c(sync.dif:trend.two)
  ) %>%
  mutate(
    lat = as.numeric(substr(grid, 1, 2)) - 0.5,
    lon = as.numeric(substr(grid, 3, 10)) + 0.5
  )

rm(syncdif.split, syncdif.sum.list)
```

```{r}
# join averaged species syncdif data to individual species data
syncdif.spp.prep = syncdif.all %>%
  select(
    spcode,
    sync.dif,
    mean.dif,
    var.dif,
    trend.dif,
    sync.one,
    mean.one,
    var.one,
    trend.one,
    sync.two,
    mean.two,
    var.two,
    trend.two,
    iteration
  ) %>%
  bind_rows(
    select(
      syncdif,
      sync.dif,
      mean.dif,
      var.dif,
      trend.dif,
      sync.one,
      mean.one,
      var.one,
      trend.one,
      sync.two,
      mean.two,
      var.two,
      trend.two,
      iteration
    )
  ) %>%
  mutate(spcode = as.factor(case_when(is.na(spcode) ~ "All species",
                                      TRUE ~ spcode)))

syncdif.spp.cor = syncdif.spp.prep %>% 
  group_by(spcode, iteration) %>%
  summarise(mean.dif.cor = cor(sync.dif, mean.dif),
            var.dif.cor = cor(sync.dif, var.dif),
            trend.dif.cor = cor(sync.dif, trend.dif),
            mean.one.cor = cor(sync.one, mean.one),
            var.one.cor = cor(sync.one, var.one),
            trend.one.cor = cor(sync.one, trend.one),
            mean.two.cor = cor(sync.two, mean.two),
            var.two.cor = cor(sync.two, var.two),
            trend.two.cor = cor(sync.two, trend.two)) %>%
  ungroup()

var.list = c("sync.dif","mean.dif", "var.dif", "trend.dif", "sync.one", "mean.one", "var.one", "trend.one", "sync.two", "mean.two", "var.two", "trend.two")

cor.var.list = c("mean.dif.cor", "var.dif.cor", "trend.dif.cor", "mean.one.cor", "var.one.cor", "trend.one.cor", "mean.two.cor", "var.two.cor", "trend.two.cor")

# average synchrony change of grid cells within species and iterations
# also correlations between synchrony and mean/variance/trends too
syncdif.spp = cbind(aggregate(
  syncdif.spp.prep[, var.list],
  by = list(syncdif.spp.prep$iteration, syncdif.spp.prep$spcode),
  mean
),
aggregate(
  syncdif.spp.prep[,c("sync.dif")],
  by = list(syncdif.spp.prep$iteration, syncdif.spp.prep$spcode),
  FUN = function(x) length(x)
)
)[,c(1:14,17)] %>%
  rename(iteration = Group.1, spcode = Group.2, n = x) %>%
  left_join(syncdif.spp.cor, by = c("spcode", "iteration"))

# get the median and quantiles of the mean synchrony change iterations 
# for plotting, individual species and all species averaged
syncdif.spp.sum = cbind(aggregate(
  syncdif.spp[, c(var.list, cor.var.list)],
  by = list(syncdif.spp$spcode),
  FUN = function(x) quantile(x, 0.5)),
  aggregate(
  syncdif.spp[, c(var.list, cor.var.list)],
  by = list(syncdif.spp$spcode),
  FUN = function(x) quantile(x, 0.05)),
  aggregate(
  syncdif.spp[, c(var.list, cor.var.list)],
  by = list(syncdif.spp$spcode),
  FUN = function(x) quantile(x, 0.95)),
  aggregate(
  syncdif.spp[,c("n")],
  by = list(syncdif.spp$spcode),
  mean)
)[,c(1:22,24:44,46:66, 68)]

colnames(syncdif.spp.sum) = c("spcode", paste0(c(var.list, cor.var.list), "_med"), paste0(c(var.list, cor.var.list), "_p5"), paste0(c(var.list, cor.var.list), "_p95"), "n")

syncdif.spp.sum = syncdif.spp.sum %>%
  mutate(
    spcode = as.character(spcode),
    fullsp = case_when(
      spcode == "eame" ~ "E. Meadowlark",
      spcode == "sppi" ~ "Sprague's Pipit",
      spcode == "noha" ~ "N. Harrier",
      spcode == "cclo" ~ "Chestnut-col. Longspur",
      spcode == "grsp" ~ "Grasshopper Sparrow",
      spcode == "upsa" ~ "Upland Sandpiper",
      spcode == "rnep" ~ "Ring-necked Pheasant",
      spcode == "vesp" ~ "Vesper Sparrow",
      spcode == "bobo" ~ "Bobolink",
      spcode == "lcsp" ~ "LeConte's Sparrow",
      spcode == "hola" ~ "Horned Lark",
      spcode == "savs" ~ "Savannah Sparrow",
      spcode == "weme" ~ "W. Meadowlark",
      spcode == "larb" ~ "Lark Bunting",
      spcode == "dick" ~ "Dickcissel",
      spcode == "bais" ~ "Baird's Sparrow",
      spcode == "sewr" ~ "Sedge Wren",
      spcode == "casp" ~ "Cassin's Sparrow",
      spcode == "lbcu" ~ "Long-billed Curlew",
      spcode == "All species" ~ "All species"
    )
  ) %>%
  mutate(
    order = case_when(spcode == "All species" ~ -0.5,
                      TRUE ~ sync.dif_med),
    fullsp = forcats::fct_reorder(fullsp, order, .desc = T)
  )

rm(syncdif.spp.prep, syncdif.spp, syncdif, syncdif.spp.cor)
```

```{r}
# synchrony change of each grid cell (median of 3000 iterations) for each species
syncdif.spp.map = cbind(aggregate(
  syncdif.all[, var.list],
  by = list(syncdif.all$spcode, syncdif.all$grid),
  median
),
aggregate(
  syncdif.all[, var.list],
  by = list(syncdif.all$spcode, syncdif.all$grid),
  FUN = function(x) quantile(x, 0.05)
),
aggregate(
  syncdif.all[, var.list],
  by = list(syncdif.all$spcode, syncdif.all$grid),
  FUN = function(x) quantile(x, 0.95)
)
)[,c(1:14,17:28,31:42)]
colnames(syncdif.spp.map) = c("spcode", "grid", paste0(var.list, "_med"), paste0(var.list, "_p5"), paste0(var.list, "_p95"))
syncdif.spp.map$lat = as.numeric(substr(syncdif.spp.map$grid,1,2))-0.5
syncdif.spp.map$lon = as.numeric(substr(syncdif.spp.map$grid,3,10))+0.5

syncdif.spp.map = syncdif.spp.map %>%
  left_join(syncdif.spp.sum[,c("spcode", "fullsp")], by = "spcode") 

rm(syncdif.all, var.list, cor.var.list)
```
# Create forest plot of synchrony change by species
```{r} 
dotplot_n = syncdif.spp.sum %>%  
  dplyr::select(spcode, sync.dif_med, n, order) %>%
  arrange(desc(order)) 

#x11(10,9)
syncdif.spp.sum %>%
  mutate(fullsp = fct_reorder(fullsp, order, .desc = F)) %>%
  ggplot() +
  geom_vline(
    aes(xintercept = 0),
    color = "red",
    linetype = 2,
    size = 1.5
  ) +
  geom_errorbarh(aes(
    xmin = sync.dif_p5,
    xmax = sync.dif_p95,
    y = fullsp,
    height = .2
  )) +
  geom_point(aes(x = sync.dif_med, y = fullsp, color = sync.dif_med), size = 4.5) +
  scale_color_distiller(name = "Mean\nchange", palette = "RdYlBu", limits = c(-0.105, 0.21)) +
#  scale_color_viridis(name = "Mean\nchange",
#                      option = "viridis",
#                      limits = c(-.105, .21)) +
  labs(x = 'Change in spatial synchrony, 1968-1993 vs. 1994-2019', y = "") +
  annotate(
    "text",
    x = 0.48,
    y = c(20.4, nrow(dotplot_n):1),
    label = c("", paste0(dotplot_n$n[1:nrow(dotplot_n)])),
    hjust = 1,
    color = "gray25",
    size = 4
  ) +
  annotate(
    "text",
    x = 0.43,
    y = nrow(dotplot_n),
    label = "n = ",
    color = "gray25"
  ) +
  annotate(
    "text",
    x = -0.3,
    y = 1:20,
    label = rev(c("LC", "LC", "LC", "VU", "VU", "LC", "LC", 
                      "LC", "LC", "LC", "LC", "LC", "LC", "LC",
                      "LC", "NT", "LC", "LC","LC","")),
    color = "gray25",
    size = 3
  ) +
  xlim(c(-0.3, 0.48)) +
  theme_bw() +
  theme(
    axis.text = element_text(size = 12, color = "black"),
    axis.title = element_text(size = 12, color = "black")
  )
 #ggsave("figures/dotplot_linear_p95.png")
```

## Load spatial data for mapping
```{r}
# Canada
can = rgdal::readOGR("data/province.shp") 
canada.fort = ggplot2::fortify(can) %>%
  filter(lat <60.0001)
rm(can)

# load Bird Conservation Region shapefile
bcr = rgdal::readOGR("data/bcr_terrestrial_shape/BCR_Terrestrial_master_International_clip.shp")
bcr.fort = ggplot2::fortify(bcr) %>%
  filter(lat <60.0001, long > -150)
rm(bcr)

# make a base map of North America
(na <- ggplot() +
  borders("world", xlim = c(-150, -60), ylim = c(35, 40), colour = "gray85", fill = "gray80")  +
  borders("state", colour = "gray85", fill = "gray80", size = 0.5) +
  geom_polygon(data=canada.fort, aes(x = long, y = lat, group=group), colour = "gray85", fill = "gray80", size = 0.5) +
  ggthemes::theme_map() + 
  coord_map('albers', lat0=30, lat1=60) )

(na.blank <- ggplot() +
  borders("world", xlim = c(-150, -60), ylim = c(25, 40), colour = "gray80", fill = "gray80")  +
#  borders("state", colour = "gray85", fill = "gray80") +
  geom_polygon(data=canada.fort, aes(x = long, y = lat, group=group), colour = "gray80", fill = "gray80") +
  ggthemes::theme_map() + 
  coord_map('albers', lat0=30, lat1=60) )

rm(canada.fort)
```
# Map change in synchrony for all species individually
```{r}
syncdif.spp.map = syncdif.spp.map %>%
  mutate(
    fullsp2 = case_when(
      as.character(fullsp) == "Chestnut-col. Longspur" ~ "C. Longspur",
      as.character(fullsp) == "Ring-necked Pheasant" ~ "R. Pheasant",
      TRUE ~ as.character(fullsp)
    ),
    fullsp2 = forcats::fct_reorder(fullsp2, as.numeric(fullsp), .desc = F)
  )

na +
  geom_tile(
    aes(x = lon, y = lat, fill = sync.dif_med),
    #alpha = .7,
    data = filter(syncdif.spp.map, sync.dif_med < .9)
  ) +
  scale_fill_distiller(palette = "RdYlBu", limits = c(-0.69, 0.58), breaks = c(-0.5,0,0.5), labels = c(-0.5,0,0.5)) +
  theme_classic() +
  facet_wrap( ~ fullsp2, ncol = 4) +
  labs(
    fill = "Mean\nchange",
    x = "",
    y = ""#,
    #title = "1968-1993 vs. 1994-2019"
  ) +
  theme(
    text = element_text(size = 15),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 10),
    legend.title.align = 0.5,
    legend.position = "bottom",
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 8),
    axis.line = element_line(color = "transparent")) +
  geom_point(
    aes(y = lat, x = lon),
    alpha = .7,
    color = "black",
    shape = "+",
    size = 1.5,
    #    stroke = 1.5,
    data = filter(syncdif.spp.map, sync.dif_p5 > 0)
  ) +
  geom_point(
    aes(y = lat, x = lon),
    alpha = .7,
    color = "white",
    shape = "-",
    size = 1.5,
    #    stroke = 1.5,
    data = filter(syncdif.spp.map, sync.dif_p95 < 0)
  ) +
  theme(panel.spacing.y = unit(-0.5, "lines"),
        panel.spacing.x = unit(-4, "lines"),
        panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        strip.text=element_text(vjust=-1.4))
ggsave("figures/Fig 3 - syncdif_tilemap_lin_long_legend2_REV2_7_10_-4_-0.5lines_trans-1.4.jpg", width = 7, height = 10, dpi = 300)
```
# Map mean change in synchrony for all species combined
```{r}
#x11(13,9)
na.blank +
  geom_tile(
    aes(x = lon, y = lat, fill = lin.dif_med),
    data = syncdif.sum,
    alpha = 1
  ) +
  scale_fill_distiller(name = "Mean\nchange", palette = "RdYlBu") +
  theme_classic() +
  theme(text = element_text(size = 15)) +
  labs(x = "", y = "") + #, title = "Change in synchrony: 1968-1993 vs. 1994-2019"
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank()
  ) +
  theme(legend.title.align = 0.5,
        legend.position = c(.85,.5)) +
  theme(axis.line = element_line(color = "transparent")) +
  geom_polygon(
    data = bcr.fort,
    aes(x = long, y = lat, group = group),
    color = "gray60",
    fill = "transparent",
    size = .5
  ) +
  geom_point(
    aes(y = lat, x = lon),
    alpha = 1,
    color = "black",
    shape = "+",
    size = 4,
    stroke = 1.25,
    data = filter(syncdif.sum, lin.dif_p5 > 0)
  ) +
  geom_point(
    aes(y = lat, x = lon),
    alpha = 1,
    color = "white",
    shape = "-",
    size = 4,
    stroke = 1.25,
    data = filter(syncdif.sum, lin.dif_p95 < 0)
  )
#ggsave("figures/mean_change_all_iterations_linear_p95_red_bcr.png")
```

# Raster map of mean change in synchrony across species
To make a shapefile for Geoda
```{r}
# Make a grid of spatial polygons to match up with meansyncdiff data
rr <- raster::raster(ext = raster::extent(-177, -52, 24, 69), res=c(2,2))
raster::values(rr) <- 1:raster::ncell(rr)
p <- raster::rasterToPolygons(rr)
attributes = tibble(lon = coordinates(p)[,1], lat = coordinates(p)[,2]) %>%
  mutate(join = 1, grid = paste(trunc(lat),trunc(lon),sep="")) %>%
  left_join(syncdif.sum, by="grid") 

p$grid = attributes$grid
p$sync.dif_med = attributes$sync.dif_med

syncdif.poly = p[is.na(p$sync.dif_med)!=T,]

#writeOGR(syncdif.poly, "C:/Users/Mike/mike_files/Research/Chapter 3 - Synchrony/GLBsynchrony/data", "syncdif.poly", driver="ESRI Shapefile")
```


# Map mean synchrony for all species individually - period 1
```{r}
na +
  geom_tile(
    aes(x = lon, y = lat, fill = sync.one_med),
    #alpha = .7,
    data = syncdif.spp.map
  ) +
  scale_fill_distiller(palette = "RdYlBu", limits = c(-0.3, 0.75), breaks = c(-0.5,0,0.5), labels = c(-0.5,0,0.5)) +
  theme_classic() +
  facet_wrap( ~ fullsp2, ncol = 4) +
  labs(
    fill = "Mean\nsynchrony",
    x = "",
    y = ""#,
    #title = "1968-1993 vs. 1994-2019"
  ) +
  theme(
    text = element_text(size = 15),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 10),
    legend.title.align = 0.5,
    legend.position = "bottom",
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 8),
    axis.line = element_line(color = "transparent")) +
  geom_point(
    aes(y = lat, x = lon),
    alpha = .7,
    color = "black",
    shape = "+",
    size = 1.5,
    data = filter(syncdif.spp.map, sync.one_p5 > 0)
  ) +
  geom_point(
    aes(y = lat, x = lon),
    alpha = .7,
    color = "white",
    shape = "-",
    size = 1.5,
    #    stroke = 1.5,
    data = filter(syncdif.spp.map, sync.one_p95 < 0)
  ) +
  theme(panel.spacing.y = unit(-0.5, "lines"),
        panel.spacing.x = unit(-4, "lines"),
        panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        strip.text=element_text(vjust=-1.4))
ggsave("figures/Fig S1 - syncmean_tilemap_per1_fix.jpg", width = 7, height = 10, dpi = 300)
```
# Map mean synchrony for all species individually - period 2
```{r}
na +
  geom_tile(
    aes(x = lon, y = lat, fill = sync.two_med),
    data = syncdif.spp.map
  ) +
  scale_fill_distiller(palette = "RdYlBu", limits = c(-0.3, 0.75), breaks = c(-0.5,0,0.5), labels = c(-0.5,0,0.5)) +
  theme_classic() +
  facet_wrap( ~ fullsp2, ncol = 4) +
  labs(
    fill = "Mean\nsynchrony",
    x = "",
    y = ""
  ) +
  theme(
    text = element_text(size = 15),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 10),
    legend.title.align = 0.5,
    legend.position = "bottom",
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 8),
    axis.line = element_line(color = "transparent")) +
  geom_point(
    aes(y = lat, x = lon),
    alpha = .7,
    color = "black",
    shape = "+",
    size = 1.5,
    #    stroke = 1.5,
    data = filter(syncdif.spp.map, sync.two_p5 > 0)
  ) +
  geom_point(
    aes(y = lat, x = lon),
    alpha = .7,
    color = "white",
    shape = "-",
    size = 1.5,
    #    stroke = 1.5,
    data = filter(syncdif.spp.map, sync.two_p95 < 0)
  ) +
  theme(panel.spacing.y = unit(-0.5, "lines"),
        panel.spacing.x = unit(-4, "lines"),
        panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        strip.text=element_text(vjust=-1.4))
ggsave("figures/Fig S2 - syncmean_tilemap_per2_fix.jpg", width = 7, height = 10, dpi = 300)
```

# Map mean _abundance_ for all species individually - period 1
```{r}
na +
  geom_tile(
    aes(x = lon, y = lat, fill = log(mean.one_med)),
    #alpha = .7,
    data = syncdif.spp.map
  ) +
  viridis::scale_fill_viridis(option = "inferno", limits = c(log(min(syncdif.spp.map$mean.two_med)), log(max(syncdif.spp.map$mean.one_med)))) +
  theme_classic() +
  facet_wrap( ~ fullsp2, ncol = 4) +
  labs(
    fill = "Ln mean\nabundance",
    x = "",
    y = ""
  ) +
  theme(
    text = element_text(size = 15),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 10),
    legend.title.align = 0.5,
    legend.position = "bottom",
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 8),
    axis.line = element_line(color = "transparent")) +
  theme(panel.spacing.y = unit(-0.5, "lines"),
        panel.spacing.x = unit(-4, "lines"),
        panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        strip.text=element_text(vjust=-1.4))
ggsave("figures/Fig S3 - individ_spp_tilemap_mean_per1_7_10_-4_-0.5lines_trans-1.4log.jpg", width = 7, height = 10, dpi = 300)
```
# Map mean _abundance_ for all species individually - period 2
```{r}
na +
  geom_tile(
    aes(x = lon, y = lat, fill = log(mean.two_med)),
    #alpha = .7,
    data = syncdif.spp.map
  ) +
  viridis::scale_fill_viridis(option = "inferno", limits = c(log(min(syncdif.spp.map$mean.two_med)), log(max(syncdif.spp.map$mean.one_med)))) +
  theme_classic() +
  facet_wrap( ~ fullsp2, ncol = 4) +
  labs(
    fill = "Ln mean\nabundance",
    x = "",
    y = ""
  ) +
  theme(
    text = element_text(size = 15),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 10),
    legend.title.align = 0.5,
    legend.position = "bottom",
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 8),
    axis.line = element_line(color = "transparent")) +
  theme(panel.spacing.y = unit(-0.5, "lines"),
        panel.spacing.x = unit(-4, "lines"),
        panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        strip.text=element_text(vjust=-1.4))
ggsave("figures/Fig S4 - individ_spp_tilemap_mean_per2_7_10_-4_-0.5lines_trans-1.4log.jpg", width = 7, height = 10, dpi = 300)
```
# Map change in mean abundance for all species individually
```{r}
na +
  geom_tile(
    aes(x = lon, y = lat, fill = 100*mean.dif_med/mean.one_med),
    data = syncdif.spp.map
  ) +
  scale_fill_distiller(palette = "RdYlBu", limits = c(-100, 100)) + 
  theme_classic() +
  facet_wrap( ~ fullsp2, ncol = 4) +
  labs(
    fill = "% change\nabund.",
    x = "",
    y = ""#,
  ) +
  theme(
    text = element_text(size = 15),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 10),
    legend.title.align = 0.5,
    legend.position = "bottom",
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 8),
    axis.line = element_line(color = "transparent")) +
  geom_point(
    aes(y = lat, x = lon),
    alpha = .7,
    color = "black",
    shape = "+",
    size = 1.5,
    #    stroke = 1.5,
    data = filter(syncdif.spp.map, 100*mean.dif_p5/mean.one_p5 > 0)
  ) +
  geom_point(
    aes(y = lat, x = lon),
    alpha = .7,
    color = "white",
    shape = "-",
    size = 1.5,
    #    stroke = 1.5,
    data = filter(syncdif.spp.map, 100*mean.dif_p95/mean.one_p95 < 0)
  ) +
  theme(panel.spacing.y = unit(-0.5, "lines"),
        panel.spacing.x = unit(-4, "lines"),
        panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        strip.text=element_text(vjust=-1.4))
ggsave("figures/Fig Sx - mean.dif_tilemap_REV2_7_10_-4_-0.5lines_trans-1.4pct.jpg", width = 7, height = 10, dpi = 300)
```
```{r}

syncdif.spp.map2 <- 
  syncdif.spp.map %>%
  mutate(pct_abund_med = 100 * mean.dif_med / mean.one_med,
         pct_var_med = 100 * var.dif_med / var.one_med)  

pctmean = ggplot(syncdif.spp.map2, aes(x = pct_abund_med, y = sync.dif_med, color = spcode)) +
  geom_point() +
  geom_smooth(method = "lm", se = F, formula = y~x, size = 1) +
  theme_bw() +
  theme(legend.position = "none",
        axis.text = element_text(size = 12)) +
  labs(x = "% change in abundance", y = "Change in synchrony")

pctvar = ggplot(syncdif.spp.map2, aes(x = pct_var_med, y = sync.dif_med, color = spcode)) +
  geom_point() +
  geom_smooth(method = "lm", se = F, formula = y~x, size = 1) +
  theme_bw() +
  theme(legend.position = "none",
        axis.text = element_text(size = 12)) +
  labs(x = "% change in variance", y = "Change in synchrony")


gridExtra::grid.arrange(pctmean, pctvar, ncol = 1)
#gg = gridExtra::arrangeGrob(pctmean, pctvar, ncol = 1)
#ggsave("figures/lmer_abund_var.jpg", gg)
#rm(gg)
```

```{r}
mean.test.pct = lme4::lmer(sync.dif_med~pct_abund_med + (1|spcode), data = syncdif.spp.map)
summary(mean.test.pct)

var.test.pct = lme4::lmer(sync.dif_med~pct_var_med + (1|spcode), data = syncdif.spp.map)
summary(var.test.pct)
```
# Map mean _variance_ for all species individually - period 1
```{r}
na +
  geom_tile(
    aes(x = lon, y = lat, fill = log(var.one_med)),
    data = syncdif.spp.map
  ) +
  viridis::scale_fill_viridis(option = "inferno", limits = c(log(min(syncdif.spp.map$var.two_med)), log(max(syncdif.spp.map$var.one_med)))) +
  theme_classic() +
  facet_wrap( ~ fullsp2, ncol = 4) +
  labs(
    fill = "Ln variance",
    x = "",
    y = ""
  ) +
  theme(
    text = element_text(size = 15),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 10),
    legend.title.align = 0.5,
    legend.position = "bottom",
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 8),
    axis.line = element_line(color = "transparent")) +
  theme(panel.spacing.y = unit(-0.5, "lines"),
        panel.spacing.x = unit(-4, "lines"),
        panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        strip.text=element_text(vjust=-1.4))
ggsave("figures/Fig S5 - individ_spp_tilemap_var_per1_7_10_-4_-0.5lines_trans-1.4.log.jpg", width = 7, height = 10, dpi = 300)
```
# Map mean _variance_ for all species individually - period 2
```{r}
na +
  geom_tile(
    aes(x = lon, y = lat, fill = log(var.two_med)),
    #alpha = .7,
    data = syncdif.spp.map
  ) +
  viridis::scale_fill_viridis(option = "inferno", limits = c(log(min(syncdif.spp.map$var.two_med)), log(max(syncdif.spp.map$var.one_med)))) +
  theme_classic() +
  facet_wrap( ~ fullsp2, ncol = 4) +
  labs(
    fill = "Ln variance",
    x = "",
    y = ""
  ) +
  theme(
    text = element_text(size = 15),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 10),
    legend.title.align = 0.5,
    legend.position = "bottom",
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 8),
    axis.line = element_line(color = "transparent")) +
  theme(panel.spacing.y = unit(-0.5, "lines"),
        panel.spacing.x = unit(-4, "lines"),
        panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        strip.text=element_text(vjust=-1.4))
ggsave("figures/Fig S6 - individ_spp_tilemap_var_per2_7_10_-4_-0.5lines_trans-1.4log.jpg", width = 7, height = 10, dpi = 300)
```

# Map change in variance for all species individually
```{r}
na +
  geom_tile(
    aes(x = lon, y = lat, fill = 100*var.dif_med/var.one_med),
    data = syncdif.spp.map
  ) +
  scale_fill_distiller(palette = "RdYlBu", limits = c(-100, 100)) + 
  theme_classic() +
  facet_wrap( ~ fullsp2, ncol = 4) +
  labs(
    fill = "% change\nvar.",
    x = "",
    y = ""#,
  ) +
  theme(
    text = element_text(size = 15),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 10),
    legend.title.align = 0.5,
    legend.position = "bottom",
    legend.title = element_text(size = 8),
    legend.text = element_text(size = 8),
    axis.line = element_line(color = "transparent")) +
  geom_point(
    aes(y = lat, x = lon),
    alpha = .7,
    color = "black",
    shape = "+",
    size = 1.5,
    #    stroke = 1.5,
    data = filter(syncdif.spp.map, 100*var.dif_p5/var.one_p5 > 0)
  ) +
  geom_point(
    aes(y = lat, x = lon),
    alpha = .7,
    color = "white",
    shape = "-",
    size = 1.5,
    #    stroke = 1.5,
    data = filter(syncdif.spp.map, 100*var.dif_p95/var.one_p95 < 0)
  ) +
  theme(panel.spacing.y = unit(-0.5, "lines"),
        panel.spacing.x = unit(-4, "lines"),
        panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        strip.text=element_text(vjust=-1.4))
ggsave("figures/Fig Sy - var.dif_tilemap_REV2_7_10_-4_-0.5lines_trans-1.4pct.jpg", width = 7, height = 10, dpi = 300)
```



# Map median synchrony for a single species and time period (to make GIFs)
For making GIFs. Make sure scales match between periods.
```{r}
# x11(width=9,height=9)
na +
  geom_point(aes(x = lon, y = lat, color = corcat), size = 3, alpha = .7, data = filter(mapsync2,lat<=59, sp=="dick")) + 
  scale_colour_manual(values = c("#ffffb2", "#fed976", "#feb24c", "#fd8d3c", "#fc4e2a", "#e31a1c", "#b10026", "#800026")) +
  theme_classic() +
  theme(text = element_text(size=15)) +
  labs(colour="Mean\nsynchrony", x="", y="", title="Period 2: 1994-2019") + 
  theme(axis.text.x = element_blank(),  axis.text.y = element_blank(),axis.ticks = element_blank()) +
  theme(legend.title.align=0.5) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.line = element_line(color = "transparent")) +
  xlim(c(-142,-59)) #+ guides(color=FALSE)
#ggsave("figures/grid4_maps/DICK_syncmed_ptmap_68.93_AR.png")
```


# Leaflet map of cluster plus grid of mean change in synchrony across species
```{r}
#qpal<-colorQuantile("OrRd", exp(g@data$strata)-1, n=9) 
#qpal = colorFactor("OrRd",clusters@data$LISA_CL)

bins <- c(-1, 0, .10, .20, .30, .4, .5, Inf)
pal <- colorBin("YlOrRd", domain = syncdif.poly$lin.dif_med, bins = bins)

leaflet() %>%
  addPolygons(data=syncdif.poly, stroke = T, fillColor = ~pal(lin.dif_med), 
              fillOpacity = .5, smoothFactor = 0.2, opacity = 1, color = "white", weight = 2, dashArray = 3) %>%
#  addPolygons(data=clust.inc, stroke = T, fillOpacity = 0, smoothFactor = 0.2, color #= "red") %>%
  addTiles()
```

# Map mean change in synchrony for all species combined (tiles)
Simple median method (no uncertainty)
```{r}
#x11(13,9)
na.blank +
  geom_tile(
    aes(x = lon, y = lat, fill = lin),
    data = syncdif.postmeds.sum,
    alpha = 1
  ) +
  scale_fill_distiller(name = "Mean\nchange", palette = "RdYlBu") +
  theme_classic() +
  theme(text = element_text(size = 15)) +
  labs(x = "", y = "") + #, title = "Change in synchrony: 1968-1993 vs. 1994-2019"
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank()
  ) +
  theme(legend.title.align = 0.5,
        legend.position = c(.85,.5)) +
  theme(axis.line = element_line(color = "transparent")) +
  geom_polygon(
    data = bcr.fort,
    aes(x = long, y = lat, group = group),
    color = "gray60",
    fill = "transparent",
    size = .5
  ) 
#ggsave("figures/mean_change_all_iterations_linear_p95_red_bcr.png")
```

# Create forest plot of correlations between synchrony and mean/variance/trends
```{r} 
cor.data = syncdif.spp.sum %>%
  select(fullsp,
         med = mean.dif.cor_med,
         p5 = mean.dif.cor_p5,
         p95 = mean.dif.cor_p95) %>%
  bind_rows(
    select(
      syncdif.spp.sum,
      fullsp,
      med = var.dif.cor_med,
      p5 = var.dif.cor_p5,
      p95 = var.dif.cor_p95
    )
  ) %>%
  bind_rows(
    select(
      syncdif.spp.sum,
      fullsp,
      med = trend.dif.cor_med,
      p5 = trend.dif.cor_p5,
      p95 = trend.dif.cor_p95
    )
  ) %>%
  mutate(metric = c(rep("ΔAbundance", 20), rep("ΔVariance", 20), rep("ΔTrend", 20)))

cor.data.sum = cor.data %>%
  filter(fullsp != "All species") %>%
  group_by(metric) %>%
  summarise(
    mean = mean(med),
    sd = sd(med),
    n = length(med),
    se = sd / sqrt(n)
  ) %>%
  ungroup()
  
cor.data.sum %>%
  ggplot() +
  geom_hline(yintercept = 0,
             linetype = 2,
             color = "darkgray") +
  geom_errorbar(
    aes(
      x = metric,
      ymin = mean - 2 * se,
      ymax = mean + 2 * se
    ),
    position = position_dodge(width = 1),
    width = 0
  ) +
  geom_point(
    aes(x = metric, y = mean),
    position = position_dodge(width = 1),
    size = 4.5,
    color = "firebrick"
  ) +
  scale_y_continuous(limits = c(-0.3, 0.3)) +
  cowplot::theme_cowplot() +
  labs(x = "", y = "Correlation with\nchange in spatial synchrony")
ggsave("figures/correlation_with_abund_variance.jpg")
```

```{r}
syncdif.spp.map %>%
  filter(spcode %in% c("bobo", "vesp")) %>%
  ggplot() +
  geom_point(aes(x = mean.one_med, y = sync.one_med)) +
  facet_wrap(~fullsp)



```
```{r}
# grid cells to include

include = syncdif.spp.map %>%
  select(spcode, grid) %>%
  distinct() %>%
  arrange(spcode, grid) %>%
  mutate(include = 1)

# note: ran bbs_posteriors.R script on cluster to produce this csv
bbs.df = read.csv("scripts//amarel//bbs_posteriors.csv") %>%
  mutate(Year0 = Year, Year = c(rep(1968:1993, 1513), rep(1994:2019, 1747)),
         Bayes.n = as.numeric(Bayes.n)) %>%
  rename(grid = Stratum) %>% 
  group_by(sp, grid, startyr) %>%
  mutate(r.n = resid(lm(Bayes.n~Year))) %>%
  ungroup() %>%
  left_join(include, by = c("sp" = "spcode", "grid")) %>%
  filter(include == 1) %>%
  arrange(sp, grid, Year) %>%
  select(spcode = sp, grid, year = Year, Bayes.n)

bbs.df %>%
  filter(spcode == "bais") %>%
  ggplot() +
  geom_line(aes(x = year, y = Bayes.n, color = grid)) +
  geom_vline(aes(xintercept = 1994))

```



# Links to data sources, code, papers, etc.
1. List of grassland bird species: https://www.mbr-pwrc.usgs.gov/bbs/grass/actlist.htm. Citation: Sauer, J. R., B. G. Peterjohn, S. Schwartz, and J. E. Hines. 1995. The Grassland Bird Home Page. Version 95.0. Patuxent Wildlife Research Center, Laurel, MD
2. BBS Route-level data fields: ftp://ftpext.usgs.gov/pub/er/md/laurel/BBS/DataFiles/Summary.txt
3. BBS RouteID info: ftp://ftpext.usgs.gov/pub/er/md/laurel/BBS/DataFiles/RegionCodes.txt
4. BBS phys strata map: https://www.pwrc.usgs.gov/bbs/StrataNames/strata_map_small.htm
5. BBS Route info txt with BCR and strata codes: ftp://ftpext.usgs.gov/pub/er/md/laurel/BBS/DataFiles/RouteInf.txt
6. BBS BCR shapefile: http://www.pwrc.usgs.gov/bba/index.cfm?fa=bba.getdata
7. Smith et al. sup data for CAR model and indices of aerial insectivores:
      https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0130768#sec016
      https://journals.plos.org/plosone/article/file?id=10.1371/journal.pone.0130768.s005&type=supplementary
8. Michel et al. README file:       https://datadryad.org/bitstream/handle/10255/dryad.96773/README.txt?sequence=2
9. Michel et al. paper with link to sup code files: https://onlinelibrary.wiley.com/doi/abs/10.1111/ecog.01798